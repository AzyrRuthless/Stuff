name: Build Tools (Android & Desktop)

on:
  workflow_dispatch:

jobs:
  build-all:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r29
        add-to-path: true

    - name: Prepare Output Directories
      run: |
        mkdir -p build/android-arm64
        mkdir -p build/android-arm32
        mkdir -p build/linux-desktop

    - name: Compile for Android ARM64
      run: |
        NDK_BIN="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
        CC="$NDK_BIN/clang"
        STRIP="$NDK_BIN/llvm-strip"
        FLAGS="--target=aarch64-linux-android21 -fPIE -pie -O3 -Wall -Wextra"
        OUT="build/android-arm64"

        $CC $FLAGS -o $OUT/heap-test brk/heap-test.c
        $CC $FLAGS -pthread -o $OUT/pipe-latency pipe-latency/pipe-latency.c
        $CC $FLAGS -o $OUT/pipebench pipebench/pipebench.c
        $CC $FLAGS -o $OUT/callbench callbench/callbench.c
        $CC $FLAGS -pthread -o $OUT/hackbench hackbench/hackbench.c
        
        # Added syscall check
        $CC $FLAGS -o $OUT/syscall-check syscall/syscall.c

        $STRIP $OUT/*

    - name: Compile for Android ARM32
      run: |
        NDK_BIN="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
        CC="$NDK_BIN/clang"
        STRIP="$NDK_BIN/llvm-strip"
        FLAGS="--target=armv7a-linux-androideabi21 -fPIE -pie -O3 -Wall -Wextra"
        OUT="build/android-arm32"

        $CC $FLAGS -o $OUT/heap-test brk/heap-test.c
        $CC $FLAGS -pthread -o $OUT/pipe-latency pipe-latency/pipe-latency.c
        $CC $FLAGS -o $OUT/pipebench pipebench/pipebench.c
        $CC $FLAGS -o $OUT/callbench callbench/callbench.c
        $CC $FLAGS -pthread -o $OUT/hackbench hackbench/hackbench.c

        # Added syscall check
        $CC $FLAGS -o $OUT/syscall-check syscall/syscall.c

        $STRIP $OUT/*

    - name: Compile for Desktop Linux
      run: |
        CC="gcc"
        STRIP="strip"
        FLAGS="-O3 -Wall -Wextra" 
        OUT="build/linux-desktop"

        $CC $FLAGS -o $OUT/heap-test brk/heap-test.c
        $CC $FLAGS -pthread -o $OUT/pipe-latency pipe-latency/pipe-latency.c
        $CC $FLAGS -o $OUT/pipebench pipebench/pipebench.c
        $CC $FLAGS -o $OUT/callbench callbench/callbench.c
        $CC $FLAGS -pthread -o $OUT/hackbench hackbench/hackbench.c

        # Added syscall check
        $CC $FLAGS -o $OUT/syscall-check syscall/syscall.c

        $STRIP $OUT/*

    - name: Generate Checksums
      run: |
        cd build
        sha256sum android-arm64/* > android-arm64/SHA256SUMS.txt
        sha256sum android-arm32/* > android-arm32/SHA256SUMS.txt
        sha256sum linux-desktop/* > linux-desktop/SHA256SUMS.txt

    - name: Upload Android ARM64 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tools-android-arm64
        path: build/android-arm64/*
        retention-days: 5

    - name: Upload Android ARM32 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tools-android-arm32
        path: build/android-arm32/*
        retention-days: 5

    - name: Upload Linux Desktop Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tools-linux-desktop
        path: build/linux-desktop/*
        retention-days: 5
